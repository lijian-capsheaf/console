# -*- coding: utf-8 -*-

__capability__ = 6

def interface_link_set(cmd, *args, **argv):
    """
    """
    def checkip(ipadd):
	import IPy
	import re
	p = re.compile('^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$')  
        if p.match(ipadd):
       	    return True
 	else:  
      	    return False 
	    

    from _interface_auxiliary import interface as iface
    from _interface_auxiliary import interface_link_set as set_link_interface

    context = argv["context"]  
    result = iface()
    interANDip = {}
    for res in result:
	interANDip[res[0]] = [res[3], res[1].lower()]
    args = list(args)
    states = ["on", "off"]
    leng = len(args)
    if leng > 0:
	if args[0] in interANDip.keys():
	    if leng > 1:
		if args[1] in states:
		    state = args[1]
		    if interANDip[args[0]][0] == []:
		        ip = ""
		    else:
		    	ip = interANDip[args[0]][0][0]
		    exit_state = set_link_interface(args[0], ip, state)
		    if exit_state != True:
			context.write("%s" %exit_state)
		    return
		else:
		    if "/" in args[1]:
			if checkip(args[1].split("/")[0]):
			    ip = args[1]
			    if leng > 2:
				if args[2] in states:
				    state = args[2]
				else:
				    state = ""
				exit_state = set_link_interface(args[0], ip, state)
				if exit_state != True:
				    context.write("%s" % exit_state)
				return
			else:
			    context.write("Unknown host")
			    return
		    elif checkip(args[1]):
			ipt = int(args[1][0:3])
			if ipt < 128:
			    mask = "255.0.0.0"
			if ipt < 192:
			    mask = "255.255.0.0"
			else:
			    mask = "255.255.255.0"
			try:
			    ip = IPy.IP(args[1]).make_net(mask)
			except:
			    context.write("param error")
			    return
			if leng > 2:
			    if args[2] in states:
				state = args[2]
			    else:
				state = ""
			    exit_state = set_link_interface(args[0], ip, state)
			    if exit_state != True:
				context.write("%s"% exit_state)
			    return
		    else:
			context.write("Unknown host")
			return
	else:
	    context.write("%s:the interface does not exist"% args[0])
  	    return
    else:
	context.write("%s:lack of neccessary parameters" % cmd)
	return
