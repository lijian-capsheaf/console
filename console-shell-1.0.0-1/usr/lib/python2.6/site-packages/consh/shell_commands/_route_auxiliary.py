#!/usr/bin/python
#-*-encoding:utf-8-*-

import os
import sys
from commands import getstatusoutput as run

def getroute():
    '''
        获取路由详细信息
        Format:[ [Destination, Gateway, Genmask, Flags Metric Ref, Use Iface]... ]
    '''
    cmd = 'route -n'
    status,output = run(cmd)
    output_line = output.split('\n')[2:]   # 获取有用信息行
    return [ [ x for x in msg.split(' ') if x ]  for msg in output_line ]
    '''
    result = []
    for msg in output_line:
        the_msg = []
        for x in msg.split(' '):
            if x:
                the_msg.append(x)
        result.append(the_msg)
    return result
    '''
def route_add(flags, destination, gateway, mask, iface = ''):
    '''
        添加一条路由
    '''
    print flags
    print destination
    print gateway
    print mask
    print iface
    try:
        dst = {'H':'-host '+destination, 'N':'-net '+destination, 'G':'default'}
        gateway = 'gw %s'%gateway
        mask = 'netmask %s'%mask
        if iface:
            iface = 'dev %s'%iface
        if flags not in 'HNG':
            return 'the parameter "flags" is error'
        destination = dst[flags]
        cmd = 'route add %s %s %s %s'%(destination, gateway, mask, iface)
        status,output = run(cmd)
        if status == 0:
            return True
        else:
            return output
    except Exception,E:
	return e

def route_del(flags, destination, gateway, mask, iface = ''):
    '''
        del a record
    '''
    try:
        dst = {'H':'-host '+destination, 'N':'-net '+destination, 'G':'default'}
        gateway = 'gw %s'%gateway
        mask = 'netmask %s'%mask
        if iface:
            iface = 'dev %s'%iface
        if flags not in 'HNG':
            return 'the parameter "flags" is error'
        destination = dst[flags]
        cmd = 'route del %s %s %s %s'%(destination, gateway, mask, iface)
        status,output = run(cmd)
        if status == 0:
            return True
        else:
            return output
    except Exception,E:
        return e

def route_fromconfig():
    cmd = '/usr/local/bin/setrouting.py'
    try:
        run(cmd)
        return True
    except Exception,e:
        return e

if __name__ == '__main__':
    print getroute()
    print route_add('N', '192.168.160.0', '192.168.11.1', '255.255.255.0', iface = 'eth9')

