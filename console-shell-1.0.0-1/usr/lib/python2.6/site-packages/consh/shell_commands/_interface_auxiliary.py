#!/usr/bin/python
#-*-encoding:utf-8-*-

import os
import sys
from commands import getstatusoutput as run
sys.path.append("/usr/local/bin")
from getIfaceStatus import *

str = '/usr/local/bin/getIfaceStatus.py'
def interface():
    '''
    getLanDmzDetail come from getIfaceStatus.py
    the format is:   [ [interface, net_status, zone, mac]... ] ,   net_status is stateï¼Œ1 is online
    '''
    def getmac(iface,macfile = '/sys/class/net/iface/address'):
        macfile = macfile.replace('iface',iface)
        with open(macfile,'r') as fd:
            return fd.readline().strip()
    result = []
    ret = list(getLanDmzDetail())
    ret.append(getWanDetail())
    ret.append(getOtherDetail()) 
    for listmsg in ret:
        #result += [[msg['interface'],msg['ip'],msg['net_status'],msg['zone']] for msg in listmsg]
        for msg in listmsg:
	    status = "DOWN"
	    if msg["net_status"] == "1":
		status = "UP"
            ip = msg['ip'].replace('</p>','')
            iplist = [ xip for xip in ip.split('<p>') if xip and xip != '-']
            result.append([msg['interface'],status,msg['zone'].replace("\xe5\x8c\xba",""), iplist])
    #retsult = [ch_list.append(macfile(ch_list[0])) for ch_list in result]
    for ch_list in result:
        ch_list.append(getmac(ch_list[0]))
    return result

def interface_link_set(interface, ip = "", state = ""):
    print state 
    try:
	if ip != "":
            cmd = 'ip address add %s dev %s'%(ip,interface)
            run(cmd)
	if state != "":
            if state == 'off': state = 'down'
            if state == 'on': state = 'up'
            cmd = 'ip link set %s %s'%(interface,state)
            run(cmd)
        return True
    except Exception,e:
        return e

def interface_vlan_add(interface, vlanid, bridge = 'br0'):
    '''
        first:  write file vlan_ethx
        second: write file br0 
    '''
    def write_file(w_file, w_line):
        if not os.path.exists(w_file):
            cmd = 'touch %s'%w_file
            run(cmd)
            cmd = 'chmod 644 %s'%w_file
            run(cmd)
        with open(w_file, 'r') as rf:
            lines = rf.read().split('\n')
        if w_line not in lines:
            cmd = 'echo %s >> %s'%(w_line, w_file)
            run(cmd)

    net_dir = '/var/efw/ethernet/'
    try:
        bridge_line = interface + '.' + vlanid
        bridge_file = net_dir + bridge
        write_file(bridge_file, bridge_line)
        vlan_line = vlanid
        vlan_file = net_dir + 'vlan_' + interface
        write_file(vlan_file, vlan_line)
        return True
    except Exception,e:
        return e

def interface_vlan_del(interface, bridge = 'br0'):
    '''
        first:  modify file vlan_ethx
        second: modify file br0 
    '''
    def write_file(w_file, w_line):
        if not os.path.exists(w_file):
            return 'the vlan is not exists!'
        with open(w_file, 'r') as rf:
            lines = rf.read().split('\n')
        if w_line not in lines:
            return 'the vlan is not exists!'
        lines.remove(w_line)
        run("> %s"%w_file)
        for line in lines:
            cmd = 'echo %s >> %s'%(line, w_file)
            run(cmd)
        return True

    net_dir = '/var/efw/ethernet/'
    try:
        bridge_line = interface
        bridge_file = net_dir + bridge
        ret = write_file(bridge_file, bridge_line)
        if ret is not True:
            return ret
        vlan_line = interface.split('.')[1]
        vlan_file = net_dir + 'vlan_' + interface.split('.')[0]
        write_file(vlan_file, vlan_line)
        return ret
    except Exception,e:
        return e

def interface_stp_set(interface, state):
    '''
    '''
    cmd = '/usr/local/bin/stp_%s %s'%(interface, state.upper())
    if 'br' not in interface or len(interface) != 3:
        return 'the interface:%s is not a bridge interface, eg: br0,br1...'%interface
    try:
        run(cmd)
        return True
    except Exception,e:
        return e

def interface_stp_set_fromconfig():
    '''
        config file: /var/efw/stp/setting
    '''
    net_dict = {}
    enable_dict = {}
    cmd = '/usr/local/bin/stp_interface enable' 
    netsetting = '/var/efw/ethernet/settings' 
    enablesetting = '/var/efw/stp/setting' 
    try:
        with open(netsetting,'r') as net_file:
            netfile_lines = net_file.read().split('\n')
        with open(enablesetting,'r') as enable_file:
            enablefile_lines = enable_file.read().split('\n')
        for line in netfile_lines:
            if '_DEV' in line:
                net_dict[line.split('_DEV')[0]] = line.split('=')[1]    # eg: net_dict['GREEN'] = 'br0'
        for line in enablefile_lines:
            if '_ENABLE=' in line:
                enable_dict[line.split('_ENABLE')[0]] = line.split('=')[1].upper() # eg: enable_dict['GREEN'] = 'ON'
        for color in net_dict:
            if color in enable_dict:
                this_cmd = cmd.replace('interface',net_dict[color])
                this_cmd = this_cmd.replace('enable',enable_dict[color])
                run(this_cmd)
        return True
    except Exception,e:
        return e


if __name__ == '__main__':

    print 'interface:'
    print interface()
    print 'interface_link_set:'
    print interface_link_set('eth5', '192.168.151.7','255.255.255.0' , 'on')
    print 'interface_vlan_add:'
    print interface_vlan_add('eth9','16')
    print 'interface_vlan_del:'
    print interface_vlan_del('eth9.16')
    print 'interface_stp_set:'
    print interface_stp_set('br0', 'on')
    print 'interface_stp_set_fromconfig:'
    print interface_stp_set_fromconfig()
