#!/usr/bin/python
#-*-coding:utf-8-*-
import re
import os
import sys
from commands import getstatusoutput as run

sys.path.append("/usr/local/bin/") 
from iface_util import *
sys.path.append("/usr/local/bin/")
from arp_table import *

def arp():
    # get list about arp
    """
    cmd = '/usr/local/bin/arp_table.py -s'
    status,output = run(cmd)
    arp_list = []
    for line in output.split('\n'):
        arp_list.append(line.strip().split(','))
    return arp_list
    """
    cmd = "arp -n | grep -v incomplete"
    lines = os.popen(cmd).readlines()
    m = re.compile("^(?P<ip>(\d+\.?){4})\s+ether\s+(?P<hw>\S+)\s+(?P<flag>\S+)\s+(?P<if_name>\S+)")
    arp_list = []
    for line in lines:
        matches = m.search(line)
        if matches:
            tmp = matches.groupdict()
	    arp_list.append([tmp.get("ip"),tmp.get("hw"),tmp.get("flag"),tmp.get("if_name")])
    return arp_list



def arp_set(ip,mac,interface = ''):

    rules = []
    try:
        ethlist = get_all_iface('eth')
        if interface and interface in ethlist:  
                obj = Entry()
		obj.ip = ip
		obj.mac = mac
		obj.interface = interface
                rules.append(obj)
        else:
            for eth in ethlist:
		obj = Entry()
		obj.ip = ip
		obj.mac = mac
		obj.interfce = eth
                rules.append(obj)
        add_solidified_arp(rules)
        return True
    except Exception,e:
        return e

def arp_del(ip = "", interface = None):

    try:
	delete_arp(ip,interface)
	return True
    except Exception,e:
        return e

def arp_del_all():
    '''delete all solidified arp entry'''
    try:
        cmd = "arp -n | grep -v incomplete"
        lines = os.popen(cmd).readlines()
        m = re.compile("^(?P<ip>(\d+\.?){4})\s+ether\s+(?P<hw>\S+)\s+(?P<flag>\S+)\s+(?P<if_name>\S+)")
        for line in lines:
            matches = m.search(line)
            if matches:
                tmp = matches.groupdict()
                delete_arp(tmp.get("ip"),tmp.get("if_name"))
        return True
    except Exception, e:
        return e

def arp_reset():
    try:
        reset_arp()
        return True
    except Exception,e:
        return e
