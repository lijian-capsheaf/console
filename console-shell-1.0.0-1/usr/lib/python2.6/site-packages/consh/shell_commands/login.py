#!/usr/bin/python
# -*- coding: utf-8 -*-
import os
import time
import sys

import consh.ansi as ansi
import consh.rights as rights
from consh.get_pass import getpass as getpassword

from collections import namedtuple

__capability__ = 1


SUPER_USER_LEVEL = 2
ROW_META = ('username','password','description','mail','level','locked','changepwdtime')
_Row=namedtuple("Row",ROW_META)

def Row(arr, tolerant=True):
    if not tolerant:
        return _Row(*arr)
    else:
        if len(arr) == len(ROW_META):
            pass
        elif len(arr) < len(ROW_META):
            arr.extend(['']*(len(ROW_META)-len(arr)))
        return _Row(*arr[:len(ROW_META)])


def validate_admin_passwd(username, password, split_char=','):

    CONF_PATH = '/var/efw/userinfo/userslist'
    CONF_PATH_DEFAULT = '/var/efw/userinfo/default_userslist'

    if not os.path.exists(CONF_PATH):
        print "Fatal Error: admin config is not existed, will reset it !"
        if not os.path.exists(CONF_PATH_DEFAULT):
            print "Error: No userinfo!"
            return rights.ERROR
        else:
            os.system("cp %s %s"%(CONF_PATH_DEFAULT, CONF_PATH))
    
    with open(CONF_PATH) as fd:
        for line in fd:
            line = line.strip()
            if not line:
                continue
           
            meta = line.split(split_char)
            # print meta
            user = Row(meta)
            # print user
            if user.locked != '0' and int(user.level) != SUPER_USER_LEVEL:
                print "This user has been locked"
                return rights.ERROR                
            if user.username == username and user.password == password:

                # print "validate success"
                if int(user.level) == SUPER_USER_LEVEL:
                    return rights.ADMIN
                else:
                    return rights.USER
    return rights.ERROR
    

def login(cmd, *args, **argv):
    """
...     
_n      User Login
_f      login [username]
	login 			input your user and pass and then login
	login [username]	input your pass and then login
     
	username and pass about web username and pass   
    """
    context = argv["context"]
    
    username = ""
    password = ""

    if len(args) == 0:
        sys.stdout.write("Your username:")
        sys.stdout.flush()
        username = context.read()
        # password = getpass.getpass("%s's password:"% username)
        sys.stdout.write("%s's password:"% username)
        sys.stdout.flush()
        password = getpassword("*")

    if len(args) > 0:
        username = args[0]
        # password = getpass.getpass("%s's password:"% username)
        sys.stdout.write("%s's password:"% username)
        sys.stdout.flush()
        password = getpassword("*")


    right = validate_admin_passwd(username, password)
    if right != rights.ERROR:
        context.start_time = time.time()
        context.shell_init(username, right)
        os.system("clear")

        hour = time.localtime().tm_hour
        if hour < 12:
	        context.write("Good morning %s%s%s%s" % (ansi.BOLD, ansi.GREEN, username, ansi.RESET))	
        elif hour < 18:
            context.write("Good afternoon %s%s%s%s" % (ansi.BOLD, ansi.GREEN, username, ansi.RESET)) 
        else:
            context.write("Good evening %s%s%s%s" % (ansi.BOLD, ansi.GREEN, username, ansi.RESET))

        context.write("You logged at %s%s%s" % (ansi.RED, context.starttime,ansi.RESET))
        context.write_log(context.starttime,"login")
        context.write("")
        context.func("show")
    else:
        time.sleep(2)
        context.write("%slogin failure%s" % (ansi.RED, ansi.RESET))
    return

if __name__ == "__main__":
    import consh.ansi as ansi
    print (ansi.RED + "This operation is not allowed." + ansi.RESET)
    raw_input(ansi.RED + "Press ENTER" + ansi.RESET)
    exit()
