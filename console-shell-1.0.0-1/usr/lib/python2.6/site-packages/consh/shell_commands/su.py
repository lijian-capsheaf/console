# -*- coding: utf-8 -*-

__capability__ = 7
DEFAULT_USER = "root"

import sys,time
from consh.shadow import get_encrypted_password, authenticate
from consh.privilege_manager import drop_privileges_temp, restore_privileges, drop_privileges

from consh.get_pass import getpass as getpass

def su(cmd, *args, **argv):
    """
...     
_n      log in to the Backgroud System
_f      su [susername]
        
    """

    context = argv["context"] 

    def log(username):
        sys.stdout.write("Password:")
        sys.stdout.flush()
        password = getpass()
        if not password:
            time.sleep(2)
            context.write("\033[31mUser authorization failure\033[0m")
            return False
        try:
       	    # Restore root privilegesa
            restore_privileges()
            # Check password
            if not authenticate(username,password):		# login fail
		# Drop root privileges
                drop_privileges_temp()
                time.sleep(2)
                context.write("\033[31mUser authorization failure\033[0m")
                return False
            else:		# login success
                # Drop root privileges permanently
                drop_privileges(username)
                return True
        except Exception,e:
            print e
            # Drop root privileges
            drop_privileges_temp()
            return False
   
    def logsu(username):
        import os, pwd
        if username =="root":
            user_path = "/root"
        else:
            user_path = "/home/" + username
        if not os.path.exists(user_path):
            os.makedirs(user_path)
        os.chdir(user_path)
        os.system("bash")
       
    if (log(DEFAULT_USER)):
        logsu(DEFAULT_USER)
