#!/usr/bin/python
#-*-encoding:utf8-*-

import os
import sys
from commands import getstatusoutput as run

def ipsengine_set(state):
    '''
        state: on/off
        return: False_msg/True
    '''

    noconf_msg = 'There is not config about ips on firewall!'
    ipsconf_file = '/var/efw/idps/engine/settings'
    cmd = '/usr/local/bin/restartips.py'

    if not os.path.exists(ipsconf_file):
        return noconf_file
    try:
        with open(ipsconf_file, 'r') as fd:
            line = fd.read()
            if not line.strip():
                return noconf_msg
        configs = line.split(',')
        configs[4] = state
        new_line = ','.join(configs)
        with open(ipsconf_file, 'w') as fd:
            fd.write(new_line)
        #sub = subprocess.Popen(cmd)
        #sub.wait()
        run(cmd)
        return True
    except Exception,e:
        return e

def virusengine_set(state):
    '''
        state:on/off
       	return: Flase_msg/True
    '''

    noconf_msg = 'There is not config about virus on firewall!'
    virusconf_file = '/var/efw/virus/conf'
    cmd = '/usr/local/bin/setvirus.py'
    #cmd = '/usr/local/bin/setvirus.py'

    if not os.path.exists(virusconf_file):
        return noconf_file
    if state == 'off':
        state = '0'
    else:
        state = '1'
    try:
        with open(virusconf_file, 'r') as fd:
            line = fd.read()
            if not line.strip():
                return noconf_msg
        configs = line.split(',')
        configs[0] = state
        new_line = ','.join(configs)
        with open(virusconf_file,'w') as fd:
            fd.write(new_line)
        run(cmd)
        os.system(cmd)
        return True
    except Exception,e:
        return e

"""
def sysinfo_events():
    '''
        the format of date: [ [datetime, event_msg]... ]
    '''
    logevent_file = '/var/log/eventwarn.log'
    with open(logevent_file , 'r') as fd:
        lines = fd.read().split('\n')
    logs = [  [line.split('    ')[0], line.split('    ')[1]] for line in lines if line ]
    return logs
"""

if __name__ == "__main__":
    print ipsengine_set('on')
    print virusengine_set('on')








