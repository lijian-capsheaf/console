# -*- coding: utf-8 -*-

__capability__ = 7
from consh.shell import HISTORY_FILENAME as HISTORY_FILENAME

def history(cmd, *args, **argv):
    """
...
_n      history commands
_f      history [-c] [-d offset] [n] or history -anrw [filename] or history -ps arg [arg...]
        Display or manipulate the history list.

        Display the history list with line numbers, prefixing each modified
        entry with a `*'.  An argument of N lists only the last N entries.

        Options:
          -c    clear the history list by deleting all of the entries
          -d offset   delete the history entry at offset OFFSET.

          -a    append history lines from this session to the history file
          -n    read all history lines not already read from the history file
          -r    read the history file and append the contents to the history list
          -w    write the current history to the history file and append them to the history list
                                                        
          -p    perform history expansion on each ARG and display the result without storing it in the history list
          -s    append the ARGs to the history list as a single entry

        If FILENAME is given, it is used as the history file.  Otherwise,
        if $HISTFILE has a value, that is used, else ~/.bash_history.
        
        If the $HISTTIMEFORMAT variable is set and not null, its value is used 
        as a format string for strftime(3) to print the time stamp associated
        with each displayed history entry.  No time stamps are printed otherwise.
        
        Exit Status:
        Returns success unless an invalid option is given or an error occurs.
    """

    context = argv["context"]
    
    def num(count):
        if int(count) < 0:
            context.write("%s:bad number"% cmd)
            return None

        else:
            return int(count)

    history_l = [num]
    history_d = {"-n":num}
    

    def read_history(lines):
        try:
           
            f = file(HISTORY_FILENAME, "r")
            hlines = f.readlines()
            import math
            lines = math.floor(int(lines))
            leng = len(hlines)
            
            llc = int(leng - lines)
            if lines < 0 or llc < 1:
                count = 0
                for hl in hlines:
                    hl = hl.rstrip()
                    count = count + 1
                    context.write(" %s  %s" % (count, hl.split("->")[1]))
            else:
                while llc < leng:
                    
                    context.write(" %s  %s" % (llc + 1, hlines[llc].split("->")[1].rstrip()))
                    llc = llc + 1
            
            f.close()
        except:
            f.close()
            print "error"
            return

    length = len(args)
    
    if length:
        if length == 1:
            if num(args[0]) != None:
                read_history(num(args[0]))
                return
            else:
                context.write("%s:not 'int' type" % args[0])
                return

        else:
            if args[0] in history_d.keys():
                if distory_d[args[0]](args[1]) != None:
                    read_history(num(args[1]))
                    return

                else:
                    context.write("%s:%s:Unknown parameter"% (cmd, args[0]))
                    return

            else:
                context.write("%s: no parameter" % args[0])
                return

    else:
        read_history(-1)
        return
