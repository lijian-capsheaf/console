#!/usr/bin/python
# -*- coding: utf-8 -*-

import os.path
import glob
import sys
import readline

#import shell
from consh.rights import Rights,get_rights

FILE_PATH = "consh/shell_commands"

note_sign = "_n"
format_sign = "_f"
separator = "_"

def isCommands(initial = ""):
    if ord(initial) > 122 or ord(initial) < 65:
        return False
    if ord(initial) < 97 and ord(initial) > 90:
        return False
    return True

class LocalResolver(object):

    def __init__(self, rights = Rights.ERROR):
        self.right = rights
	# Third party library path
        self.path = "/usr/lib/python2.6/site-packages"
        self.module_names = self.get_module_names()
        # import module
        self.import_module(self.module_names)
    # 获取模块名字string
    def get_module_names(self,line = "", allmodule = False):
        """
            get module from line,return module[...]
        """
        module_names = []
        filepath = ""
        
        # add "/" for filepath
        if self.path[len(self.path) - 1] == "/":
            self.path = self.path[:-1]
        if FILE_PATH[len(FILE_PATH) - 1] != "/":
            filepath = self.path + "/" + FILE_PATH + "/"
        else:
            filepath = self.path + "/" + FILE_PATH
        line = line.lstrip()
        line = line.rstrip()
        lines = line.split()
        line = ""
        l = len(lines)
        i = 0
        while  i < l:
            if lines[i] != "":
                line = line + lines[i] + separator
            i = i + 1
        
        #add "_" for filename
        if line != "":
            if line[len(line) - 1] != separator:
                line = line + separator
        
        filenames = glob.glob(r"%s%s*.py"%(filepath, line))     # get all file
        for filename in filenames:
            try:
                file_temp = filename.split("/")     # get a list split by "/"
                file_temp = file_temp[len(file_temp) - 1].split(".")    # last file_temp is filename
		        # deal file
                if not isCommands(file_temp[0][0]):
                    continue
                if file_temp[0] in module_names:
                    continue
                if not allmodule:
                    if line == "":
                        if separator in file_temp[0]:
                            continue
                    else:
                        if file_temp[0].startswith(line):
                            tempp = file_temp[0].split(line)[1]
                            if separator in tempp:
                                continue
                        else:
                            continue
                # deal right
                if (self.right & get_rights(FILE_PATH.replace("/",".") + "." + file_temp[0])) < 1:
                    continue
              
                module_names.append(file_temp[0])

            except:
                continue

        while "" in module_names:
            module_names.remove("")
        module_names.sort()
        return module_names
   

    def import_module(self, module_names = []):
        """
            import module to sys
        """
        inum = 0
        for module_name in module_names:
            if isinstance(module_name, str):
                if module_name in sys.modules.keys():
                    continue
                else:
                    try:
                        __import__(FILE_PATH.replace("/",".") + "."+ module_name)
                        inum = inum + 1
                    except:
                        print "Error when load command: %s"%module_name
                        continue
            else:
                continue
        return inum

    def get_module(self, module_name = ""):
        """
            get module object
        """
        try:
            if not (FILE_PATH + "." + module_name in sys.modules.keys()):
                __import__(FILE_PATH.replace("/",".") + "." + module_name)
            return sys.modules[FILE_PATH.replace("/",".") + "." + module_name]        
        except:
            return None

    def get_func(self, module, func_n = ""):
        return getattr(module, func_n)

    # get commands from line
    def get_commands(self, line = "",allcommands = False):
        """
            get next commands
        """

        commands = []
        file_name = self.get_module_names(line,allcommands)
        if line:
            line = line.lstrip()
            line = line.rstrip()
            lines = line.split()
            line = ""
            l = len(lines)
            i = 0
            while i < l:
                if lines[i] != "":
                    line = line + lines[i] + separator
                i = i + 1
            for command in file_name:
                lists = command.split(line)
                command = lists[1].lstrip(separator)
                commands.append(command)
        else:
            commands = file_name
        return commands
    
    def get_realcmd(self,line = ""):
        """
            get a really command if that is a alias
        """
        lines = line.split()
        while "" in lines:
            lines.remove("")
        command = ""
        for cmd in lines:
            cmd = self.has_command(cmd,command)
            if cmd == None:
                break
            command = command + " " + cmd
        command = command.lstrip()
        return command


    def lookup_param(self,line):
        try:
            lines = line.split()
            while "" in lines:
                lines.remove("")
            i = 0
            params = ""
            while lines[i] in get_commands(params):
                params = params + " " + lines[i]
                i = i + 1 
            return params
        except:
            return params


    def get_alias(self,line = "",allalias = False):
        """
            get all aliases
        """
        aliases = {}
        try:

            for module_name in self.get_module_names(line):
                
                modulename = FILE_PATH.replace("/",".") + "." + module_name
                if modulename not in sys.modules.keys():
                    __import__(modulename)
                module = sys.modules[modulename]
                try: 
                    alias = module.__alias__
                    
                    if isinstance(alias, list):
                        while "" in alias:
                            alias.remove("")
                        for alikey in alias:
                            alivalue = module_name
                            if "_" in alivalue:
                                alivalue = alivalue.split("_")[-1]
                            aliases[alikey] = alivalue
                    else:
                        continue
                except:
                    continue
            return aliases
        except:
            return None

    def has_command(self, cmd,line =""):
        # alias
        alias = self.get_alias(line)
        if alias != None:
            if cmd in alias.keys():
                return alias[cmd]

        # cmd
        if cmd in self.get_commands(line):
            return cmd   
        else:
            return None

    def get_func_doc(self,func):
        """
            get function's doc
        """
        note = ""
        format = ""
        description = ""
        
        if func.__doc__:
            for line in func.__doc__.split("\n"):
                if line.startswith("..."):
                    continue
                if line.startswith(note_sign):
                    if line:
                        note = note + line.split(note_sign)[1] + "\n" 
                elif line.startswith(format_sign):
                    if line:
                        format = format + line.split(format_sign)[1] + "\n" 
                else:
                    if line:
                        description = description + line + "\n" 
            note = note.strip("\n")
 	    format = format.strip("\n")
	    description = description.strip("\n")
        return {"note":note, "format":format, "description":description}


if __name__ == "__main__":
    exit()
