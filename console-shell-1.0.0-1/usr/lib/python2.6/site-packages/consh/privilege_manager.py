import os
import pwd
import grp


DEFAULT_USER = "nobody"
DEFAULT_UID = -2

DEFAULT_GROUP = "nogroup"
DEFAULT_GID = -2

try:
    import ctypes
    import ctypes.util
    libc = ctypes.cdll.LoadLibrary(ctypes.util.find_library('c'))

    setreuid = libc.setreuid # set real and/or effective user id
    try:
        setresuid = libc.setresuid # set real, effective and saved user id
        setresgid = libc.setresgid # set real, effective and saved group id
    except AttributeError:
        setresuid = None
        setresgid = None
        
except ImportError:
    setreuid = None
    setresuid = None
    setresgid = None


_saved_uid = None
_saved_gid = None
_save_groups = None


def _get_uid_gid(user=None):
    try:        
        user = pwd.getpwnam(user or DEFAULT_USER)
        uid = user[2]
        gid = user[3]
    except Exception:
        uid = DEFAULT_UID
        try:
            gid = grp.getgrnam(DEFAULT_GROUP)[2]
        except Exception:
            gid = DEFAULT_GID
    return (uid, gid)

def _set_group(new_gid, groups=None):
    result = True
    try:
        os.setgroups(groups or [])
    except:
        result = False
    try:
        os.setgid(new_gid)
    except:
        result = False
    return result
        
def drop_privileges_temp(new_user=None):
    """ Drop root privileges temporarily"""
    global _saved_uid, _saved_gid, _save_groups
    _saved_uid = os.geteuid()
    _saved_gid = os.getgid()
    _save_groups = os.getgroups()
    
    new_uid, new_gid = _get_uid_gid(new_user)
    result = True
    
    # Set group/groups
    if not _set_group(new_gid):
        result = False
        
    # Set real and effective uid
    if setresuid:
        if setresuid(new_uid, new_uid, os.geteuid()) != 0:
            result = False
    elif setreuid:
        if setreuid(new_uid, new_uid) != 0:
            result = False
    else:
        result = False
                
    # Check the new effective user id
    if os.geteuid() != new_uid:
        result = False
    return result


def restore_privileges():
    """ Restore root privileges """
    global _saved_uid, _saved_gid, _save_groups
    result = True
    
    # Restore uid
    if setresuid:
        if setresuid(_saved_uid, _saved_uid, -1) != 0:
            result = False
    elif setreuid:
        if setreuid(_saved_uid, _saved_uid) != 0:
            result = False
    else:
        result = False

    # Restore group/groups
    if not _set_group(_saved_gid, _save_groups):
        result = False

    # Check effective user id vs saved user id
    if os.geteuid() != _saved_uid:
        result = False
    return result


def drop_privileges(new_user=None):
    """ Drop root privileges permanently """ 
    global _saved_uid, _saved_gid, _save_groups
    _saved_uid = None
    _saved_gid = None
    _save_groups = None

    new_uid, new_gid = _get_uid_gid(new_user)
    result = True
    
    # Set group/groups
    if not _set_group(new_gid):
        result = False
        
    # Set real, effective and saved uid     
    if setresuid:
        if setresuid(new_uid, new_uid, new_uid) != 0:
            result = False
    else:
        try:
            os.setuid(new_uid)
        except:
            result = False
        if setreuid and setreuid(new_uid, new_uid) != 0:
            result = False

    # Check the new effective user id
    if os.geteuid() != new_uid:
        result = False
    return result


__all__ = ['drop_privileges_temp', 'restore_privileges', 'drop_privileges']


if __name__ == "__main__":
    import os
    drop_privileges_temp()
    os.system("id")
    try:
        f = open("/etc/shadow")
        raise Exception("XXXXX")
    except IOError: # ok
        pass 
    
    restore_privileges()
    os.system("id")

